(function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("dexie")):"function"==typeof define&&define.amd?define(["dexie"],n):(e.Dexie=e.Dexie||{},e.Dexie.Observable=n(e.Dexie))})(this,function(O){"use strict";function S(){}function T(o,i){return o===S?i:function(){var e=o.apply(this,arguments);if(e&&"function"==typeof e.then){var n=this,t=arguments;return e.then(function(){return i.apply(n,t)})}return i.apply(this,arguments)}}function c(){var t=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?n:7&n|8).toString(16)})}O=O&&O.hasOwnProperty("default")?O.default:O;var u=1,v=2,a=3;function D(t){return function(e){if(!e.hook._observing){e.hook._observing=!0;var n=e.name;e.hook("creating").subscribe(function(a,s){return function(n,e,t){var o=void 0;void 0===n&&s.schema.primKey.uuid&&(n=o=c(),s.schema.primKey.keyPath&&O.setByKeyPath(e,s.schema.primKey.keyPath,n));var i={source:t.source||null,table:s.name,key:void 0===n?null:n,type:u,obj:e},r=a._changes.add(i).then(function(e){return t._lastWrittenRevision=Math.max(t._lastWrittenRevision,e),e});return this.onsuccess=function(e){n!=e&&r._then(function(){i.key=e,a._changes.put(i)})},this.onerror=function(){r._then(function(e){a._changes.delete(e)})},o}}(t,e)),e.hook("updating").subscribe(function(f,m){return function(e,n,t,o){var i={},r=!1,a=O.deepClone(t);for(var s in e){var c=e[s];if(void 0===c)O.delByKeyPath(a,s),r=!(i[s]=null);else{var u=O.getByKeyPath(t,s);c!==u&&JSON.stringify(c)!==JSON.stringify(u)&&(O.setByKeyPath(a,s,c),i[s]=c,r=!0)}}if(r){var l={source:o.source||null,table:m,key:n,type:v,mods:i,oldObj:t,obj:a},d=f._changes.add(l);this.onsuccess=function(){d._then(function(e){o._lastWrittenRevision=Math.max(o._lastWrittenRevision,e)})},this.onerror=function(){d._then(function(e){f._changes.delete(e)})}}}}(t,n)),e.hook("deleting").subscribe(function(i,r){return function(e,n,t){var o=i._changes.add({source:t.source||null,table:r,key:e,type:a,oldObj:n}).then(function(e){return t._lastWrittenRevision=Math.max(t._lastWrittenRevision,e),e}).catch(function(e){console.log(n),console.log(e.stack)});this.onerror=function(){o._then(function(e){i._changes.delete(e)})}}}(t,n))}}}var l=O.Promise;function C(r,a,e,s,c){var u={};function n(){return s.node?O.ignoreTransaction(function(){return r.transaction("rw","_intercomm",function(){return r._intercomm.where({destinationNode:s.node.id}).toArray(function(e){return e.forEach(function(e){return function(n){if("response"===n.type){var e=u[n.requestId.toString()];e&&(n.isFailure?e.reject(n.message.error):e.resolve(n.message.result),delete u[n.requestId.toString()])}else n.resolve=function(e){r.observable.sendMessage("response",{result:e},n.sender,{requestId:n.id})},n.reject=function(e){r.observable.sendMessage("response",{error:e.toString()},n.sender,{isFailure:!0,requestId:n.id})},r.on.message.fire(n)}(e)}),r._intercomm.where("id").anyOf(e.map(function(e){return e.id})).delete()})})}):l.reject(new O.DatabaseClosedError)}return r.observable.sendMessage=function(e,n,t,o){if(o=o||{},!s.node)return o.wantReply?l.reject(new O.DatabaseClosedError):l.resolve();var i={message:n,destinationNode:t,sender:s.node.id,type:e};return O.extend(i,o),O.ignoreTransaction(function(){var e=["_intercomm"];o.wantReply&&e.push("_syncNodes");var n=r.transaction("rw",e,function(){return o.wantReply?r._syncNodes.where("id").equals(t).count(function(e){return e?r._intercomm.add(i):r._syncNodes.where("isMaster").above(0).first(function(e){return i.destinationNode=e.id,r._intercomm.add(i)})}):r._intercomm.add(i)}).then(function(t){var e=null;return o.wantReply&&(e=new l(function(e,n){u[t.toString()]={resolve:e,reject:n}})),c&&c.setItem("Dexie.Observable/intercomm/"+r.name,t.toString()),a.on.intercomm.fire(r.name),e});return o.wantReply?n:void n.catch(function(){})})},r.observable.broadcastMessage=function(n,t,o){if(s.node){var i=s.node.id;O.ignoreTransaction(function(){r._syncNodes.toArray(function(e){return l.all(e.filter(function(e){return"local"===e.type&&(o||e.id!==i)}).map(function(e){return r.observable.sendMessage(n,t,e.id)}))}).catch(function(){})})}},{onIntercomm:function(e){e===r.name&&n().catch("DatabaseClosedError",function(){})},consumeIntercommMessages:n}}function I(n){return function(e,t){e._changes="++rev",e._syncNodes="++id,myRevision,lastHeartBeat,&url,isMaster,type,status",e._intercomm="++id,destinationNode",e._uncommittedChanges="++id,node",n.call(this,e,t),Object.keys(t).forEach(function(e){var n=t[e];0===n.primKey.name.indexOf("$$")&&(n.primKey.uuid=!0,n.primKey.name=n.primKey.name.substr(2),n.primKey.keyPath=n.primKey.keyPath.substr(2))}),Object.keys(t).forEach(function(e){0!==e.indexOf("_")&&0!==e.indexOf("$")&&(t[e].observable=!0)})}}var s,M=self,j=O.defineClass({rev:Number,source:String,table:String,key:Object,type:Number,obj:Object,mods:Object,oldObj:Object}),B=O.override,k=O.Promise,E=!1;function H(a){var o=2e4,i=2e4,t=500,r=o-5e3,s=H.localStorageImpl,c=O.defineClass({myRevision:Number,type:String,lastHeartBeat:Number,deleteTimeStamp:Number,url:String,isMaster:Number,syncProtocol:String,syncContext:null,syncOptions:Object,connected:!1,status:Number,appliedRemoteRevision:null,remoteBaseRevisions:[{local:Number,remote:null}],dbUploadState:{tablesToUpload:[String],currentTable:String,currentKey:null,localBaseRevision:Number}});a.observable={},a.observable.SyncNode=c;var n=function(n,t,o){return function(e){t.latestRevision[n.name]<e&&(t.latestRevision[n.name]=e,O.ignoreTransaction(function(){t.on("latestRevisionIncremented").fire(n.name,e)}),o&&o.setItem("Dexie.Observable/latestRevision/"+n.name,e))}}(a,H,s),e=function(s,c){return function(a){return function(e,n,t,o){if(s.dynamicallyOpened())return a.apply(this,arguments);var i=!1;"readwrite"===e&&n.some(function(e){return t[e]&&t[e].observable})&&(i=!0,-1===(n=n.slice(0)).indexOf("_changes")&&n.push("_changes"));var r=a.call(this,e,n,t,o);return i&&(r._lastWrittenRevision=0,r.on("complete",function(){if(r._lastWrittenRevision)if(o){var e=function e(n){return n.parent?e(n.parent):n}(o);e._lastWrittenRevision=Math.max(r._lastWrittenRevision,e.lastWrittenRevision||0)}else c.timeoutHandle&&clearTimeout(c.timeoutHandle),c.timeoutHandle=setTimeout(function(){delete c.timeoutHandle,c(r._lastWrittenRevision)},25)}),r.parent&&r.parent.source&&(r.source=r.parent.source)),r}}}(a,n),u=D(a),l=function(t,o,i){return function(e){return function(){return Object.keys(t._allTables).forEach(function(e){var n=t._allTables[e];n.schema.observable&&i(n),"_syncNodes"===n.name&&n.mapToClass(o)}),e.apply(this,arguments)}}}(a,c,u),d={node:null},f=C(a,H,0,d,s),m=f.onIntercomm,v=f.consumeIntercommMessages;Object.defineProperty(a,"_localSyncNode",{get:function(){return d.node}});var y=null,p=null;O.fake&&(a.version(1).stores({_syncNodes:"++id,myRevision,lastHeartBeat",_changes:"++rev",_intercomm:"++id,destinationNode",_uncommittedChanges:"++id,node"}),a._syncNodes.mapToClass(c),a._changes.mapToClass(j),d.node=new c({myRevision:0,type:"local",lastHeartBeat:Date.now(),deleteTimeStamp:null})),a.Version.prototype._parseStoresSpec=B(a.Version.prototype._parseStoresSpec,I),a.on.addEventType({changes:"asap",cleanup:[T,S],message:"asap"}),a._createTransaction=B(a._createTransaction,e),H.latestRevision[a.name]=H.latestRevision[a.name]||0,a.open=B(a.open,l),a.close=B(a.close,function(e){return function(){return a.dynamicallyOpened()||(n.timeoutHandle&&(clearTimeout(n.timeoutHandle),delete n.timeoutHandle),H.on("latestRevisionIncremented").unsubscribe(b),H.on("suicideNurseCall").unsubscribe(N),H.on("intercomm").unsubscribe(m),H.on("beforeunload").unsubscribe(w),d.node&&d.node.id&&(H.on.suicideNurseCall.fire(a.name,d.node.id),s&&s.setItem("Dexie.Observable/deadnode:"+d.node.id.toString()+"/"+a.name,"dead"),d.node.deleteTimeStamp=1,d.node.lastHeartBeat=0,a._syncNodes.put(d.node),d.node=null),y&&clearTimeout(y),y=null,p&&clearTimeout(p),p=null),e.apply(this,arguments)}}),a.delete=B(a.delete,function(e){return function(){return e.apply(this,arguments).then(function(e){return H.latestRevision[a.name]=0,e})}}),a.on("ready",function(){return a.dynamicallyOpened()?a:a.table("_changes").orderBy("rev").last(function(e){var n=e?e.rev:0;return d.node=new c({myRevision:n,type:"local",lastHeartBeat:Date.now(),deleteTimeStamp:null,isMaster:0}),H.latestRevision[a.name]<n&&(H.latestRevision[a.name]=n,O.ignoreTransaction(function(){H.on.latestRevisionIncremented.fire(n)})),a.transaction("rw","_syncNodes",function(){return a._syncNodes.where("isMaster").equals(1).first(function(e){if(e){if(e.lastHeartBeat<Date.now()-o)return d.node.isMaster=1,e.isMaster=0,a._syncNodes.put(e)}else d.node.isMaster=1}).then(function(){return a._syncNodes.add(d.node).then(function(){H.on("latestRevisionIncremented",b),H.on("beforeunload",w),H.on("suicideNurseCall",N),H.on("intercomm",m),y=setTimeout(x,t),p=setTimeout(_,r)})})}).then(function(){R()})})},!0);var h=0;function b(e,n){if(e===a.name){if(n<=h)return;h=n,O.vip(function(){g(n).catch("DatabaseClosedError",function(){})})}}function g(e,n,o){if(!n&&g.ongoingOperation)return g.ongoingOperation;var i=!1,r=d.node;if(!r)return k.reject(new O.DatabaseClosedError);var t=a._changes.where("rev").above(r.myRevision).limit(1e3).toArray(function(e){if(0<e.length){var n=e[e.length-1];i=1e3===e.length,a.on("changes").fire(e,i),r.myRevision=n.rev}else o&&a.on("changes").fire([],!1);var t=!1;return a._syncNodes.where(":id").equals(r.id).modify(function(e){t=!0,e.lastHeartBeat=Date.now(),e.deleteTimeStamp=null,e.myRevision=Math.max(e.myRevision,r.myRevision)}).then(function(){return t})}).then(function(e){if(!e)throw E?new Error("Browser is shutting down"):(a.close(),console.error("Out of sync"),M.location&&M.location.reload(!0),new Error("Out of sync"));if(i||H.latestRevision[a.name]>r.myRevision)return g(H.latestRevision[a.name],(n||0)+1,i)}).finally(function(){delete g.ongoingOperation});return n||(g.ongoingOperation=t),t}function _(){p=null;var e=d.node&&d.node.id;e&&a.transaction("rw!",a._syncNodes,function(){a._syncNodes.where({id:e}).first(function(e){if(e)return e.lastHeartBeat=Date.now(),e.deleteTimeStamp=null,a._syncNodes.put(e);a.isOpen()&&a.close()})}).catch("DatabaseClosedError",function(){}).finally(function(){d.node&&d.node.id===e&&a.isOpen()&&(p=setTimeout(_,r))})}function x(){y=null;var e=d.node&&d.node.id;e&&O.vip(function(){g(H.latestRevision[a.name]).then(R).then(v).catch("DatabaseClosedError",function(){}).finally(function(){d.node&&d.node.id===e&&a.isOpen()&&(y=setTimeout(x,t))})})}function R(){var t=d.node;return t?a.transaction("rw","_syncNodes","_changes","_intercomm",function(){var n=!1;a._syncNodes.where("lastHeartBeat").below(Date.now()-o).filter(function(e){return"local"===e.type}).modify(function(e){e.deleteTimeStamp&&e.deleteTimeStamp<Date.now()?(delete this.value,s&&s.removeItem("Dexie.Observable/deadnode:"+e.id+"/"+a.name),e.isMaster&&(a._syncNodes.update(t,{isMaster:1}),n=!0),a._intercomm.where({destinationNode:e.id}).modify(function(e){e.wantReply?e.destinationNode=t.id:delete this.value})):e.deleteTimeStamp||(e.deleteTimeStamp=Date.now()+i)}).then(function(){return H.deleteOldChanges(a),a.on("cleanup").fire(n)})}):k.reject(new O.DatabaseClosedError)}function w(){d.node&&(E=!0,d.node.deleteTimeStamp=1,d.node.lastHeartBeat=0,a._syncNodes.put(d.node),H.wereTheOneDying=!0,s&&s.setItem("Dexie.Observable/deadnode:"+d.node.id.toString()+"/"+a.name,"dead"))}function N(e,n){e!==a.name||H.wereTheOneDying||O.vip(function(){a._syncNodes.update(n,{deleteTimeStamp:1,lastHeartBeat:0}).then(R)})}}H.latestRevision={},H.on=O.Events(null,"latestRevisionIncremented","suicideNurseCall","intercomm","beforeunload"),H.createUUID=c,H.deleteOldChanges=function n(t){O.ignoreTransaction(function(){return t._syncNodes.orderBy("myRevision").first(function(e){return t._changes.where("rev").below(e.myRevision).limit(100).primaryKeys()}).then(function(e){if(0!==e.length)return t._changes.bulkDelete(e).then(function(){100===e.length&&setTimeout(function(){return t.isOpen()&&n(t)},500)})})}).catch(function(){})},H._onStorage=(s=H,function(e){if(0===e.key.indexOf("Dexie.Observable/")){var n=e.key.split("/"),t=n[1],o=n[2];if("latestRevision"===t){var i=parseInt(e.newValue,10);!isNaN(i)&&i>s.latestRevision[o]&&(s.latestRevision[o]=i,O.ignoreTransaction(function(){s.on("latestRevisionIncremented").fire(o,i)}))}else if(0===t.indexOf("deadnode:")){var r=parseInt(t.split(":")[1],10);e.newValue&&s.on.suicideNurseCall.fire(o,r)}else"intercomm"===t&&e.newValue&&s.on.intercomm.fire(o)}}),H._onBeforeUnload=function(){H.on.beforeunload.fire()};try{H.localStorageImpl=M.localStorage}catch(e){}return M.addEventListener&&(M.addEventListener("storage",H._onStorage),M.addEventListener("beforeunload",H._onBeforeUnload)),O.Observable=H,O.addons.push(H),H});